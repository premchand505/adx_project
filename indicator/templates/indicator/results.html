<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ADX Analysis Result</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f6f8fb;
      color: #0f172a;
      margin: 0;
      padding: 20px;
    }
    .container-card { max-width: 1150px; margin: 16px auto; }
    .card-plot {
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(20,30,50,0.07);
      background: #ffffff;
      padding: 20px;
    }
    .header-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .meta-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .stat { font-size:14px; }
    .stat .num { font-weight:700; margin-left:6px; }
    .chart-holder { width:100%; height:520px; }
    @media (max-width:720px) {
      .chart-holder { height:380px; }
      .meta-row { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="container-card">
    <div class="card-plot">

      <div class="header-title">ADX Analysis Result</div>

      <div class="meta-row">
        <div class="stat">
          Latest:
          <span class="num" id="latest-adx">ADX: —</span>
          <span class="num" id="latest-pdi" style="color:#16a34a">+DI: —</span>
          <span class="num" id="latest-mdi" style="color:#ef4444">-DI: —</span>
        </div>

        <a class="btn btn-outline-primary btn-sm" href="{% url 'indicator:download' %}">⬇ Download CSV</a>
      </div>

      <div id="chart" class="chart-holder"></div>
    </div>
  </div>

  <!-- Embedded JSON -->
  <script id="plot-data" type="application/json">
    {{ plot_json|safe }}
  </script>

  <script>
    (function(){
      let rawText = document.getElementById('plot-data').textContent || '{}';
      let data = {};
      try { data = JSON.parse(rawText); } catch(e){ console.error(e); data={}; }

      const x = data.x || [];
      const adx = (data.ADX || []).map(v => v === null ? null : Number(v));
      const pdi = (data['+DI14'] || []).map(v => v === null ? null : Number(v));
      const mdi = (data['-DI14'] || []).map(v => v === null ? null : Number(v));

      //Update Latest Values
      const latest = data.latest || {};
      const set = (id,val) => document.getElementById(id).textContent = val;

      set('latest-adx', "ADX: " + (latest.ADX != null ? latest.ADX.toFixed(2) : "—"));
      set('latest-pdi', "+DI: " + (latest['+DI14'] != null ? latest['+DI14'].toFixed(2) : "—"));
      set('latest-mdi', "-DI: " + (latest['-DI14'] != null ? latest['-DI14'].toFixed(2) : "—"));

      //Colors
      const COLORS = {
        adx: '#f59e0b',    
        pdi: '#16a34a',    
        mdi: '#ef4444'     
      };

      //Hover Strength Logic
      function trendStrength(adxVal) {
        if (adxVal < 20) return "Weak";
        if (adxVal < 25) return "Moderate";
        return "Strong";
      }

      //Traces
      const trace_pdi = {
        x, y: pdi, name: '+DI',
        mode: 'lines',
        line: { width: 1.0, color: COLORS.pdi },
        hovertemplate: `
          %{x}<br>
          +DI: %{y:.2f}<br>
          Difference: %{customdata:.2f}<extra></extra>
        `,
        customdata: pdi.map((v,i)=> v!=null && mdi[i]!=null ? (v - mdi[i]) : null)
      };

      const trace_mdi = {
        x, y: mdi, name: '-DI',
        mode: 'lines',
        line: { width: 1.0, color: COLORS.mdi },
        hovertemplate: `
          %{x}<br>
          -DI: %{y:.2f}<br>
          Difference: %{customdata:.2f}<extra></extra>
        `,
        customdata: mdi.map((v,i)=> pdi[i]!=null && v!=null ? (pdi[i] - v) : null)
      };

      const trace_adx = {
        x, y: adx, name: 'ADX',
        mode: 'lines',
        line: { width: 1.2, color: COLORS.adx },
        hovertemplate: `
          %{x}<br>
          ADX: %{y:.2f}<br>
          Trend: %{customdata}<extra></extra>
        `,
        customdata: adx.map(v => v!=null ? trendStrength(v) : "")
      };

      // X-Axis Tick Sampling
      const maxTicks = 12;
      let xaxisConfig = {
        title: '',
        tickangle: -45,
        automargin: true,
        rangeslider: { visible: true, thickness: 0.05 },
        type: 'category'
      };

      if (x.length > maxTicks) {
        const step = Math.ceil(x.length / maxTicks);
        const ticks = [];
        for (let i = 0; i < x.length; i += step) ticks.push(x[i]);
        if (ticks[ticks.length-1] !== x[x.length-1]) ticks.push(x[x.length-1]);

        xaxisConfig.tickmode = 'array';
        xaxisConfig.tickvals = ticks;
        xaxisConfig.ticktext = ticks;
      } else {
        xaxisConfig.tickmode = 'auto';
        xaxisConfig.nticks = Math.max(6, x.length);
      }

      //Dynamic Rounded Y Ticks (Option C)
      const allY = [...adx, ...pdi, ...mdi].filter(v => v != null);
      const maxY = allY.length ? Math.max(...allY) : 50;
      const roundedMax = Math.ceil(maxY / 10) * 10;
      const yTicks = [];
      for (let i = 0; i <= roundedMax; i += 10) yTicks.push(i);

      const layout = {
        margin: { l: 62, r: 30, t: 36, b: 70 },
        legend: { orientation: 'h', y: 1.07, x: 0 },
        hovermode: 'x unified',
        xaxis: xaxisConfig,
        yaxis: {
          title: 'Value',
          tickmode: 'array',
          tickvals: yTicks,
          ticktext: yTicks.map(t => t.toString()),
          gridcolor: '#e5e7eb'
        },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
      };

      const config = {
        responsive: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['select2d','lasso2d']
      };

      Plotly.newPlot('chart', [trace_pdi, trace_mdi, trace_adx], layout, config);

      window.addEventListener('resize', ()=> Plotly.Plots.resize('chart'));
    })();
  </script>
</body>
</html>
